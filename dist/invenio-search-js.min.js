/*
 * This file is part of Invenio.
 * Copyright (C) 2015 CERN.
 *
 * Invenio is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License as
 * published by the Free Software Foundation; either version 2 of the
 * License, or (at your option) any later version.
 *
 * Invenio is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with Invenio; if not, write to the Free Software Foundation, Inc.,
 * 59 Temple Place, Suite 330, Boston, MA 02111-1307, USA.
 *
 * In applying this license, CERN does not
 * waive the privileges and immunities granted to it by virtue of its status
 * as an Intergovernmental Organization or submit itself to any jurisdiction.
 */
function invenioSearchConfiguration(e){e.html5Mode({enabled:!0,requireBase:!1,rewriteLinks:!1})}function invenioSearchCtrl(e,n,r){function i(){return n.get()}function a(){function n(){d.invenioSearchLoading=!1,e.$broadcast("invenio.search.finished")}function i(n){e.$broadcast("invenio.search.success",n)}function a(n){e.$broadcast("invenio.search.error",n)}e.$broadcast("invenio.search.requested"),d.invenioSearchLoading=!0,d.invenioSearchError={},d.invenioSearchErrorsResults={},r.search(d.invenioSearchCurrentArgs,d.invenioSearchHiddenParams).then(i,a).finally(n)}function t(e){for(var n=(e.split("?")[1]||"").split("&"),r={},i=0;i<n.length;i+=1){var a=(n[i]||"").split("="),t=decodeURIComponent(a[0]||"");t&&(r[t]=decodeURIComponent(a[1]||""))}return r}function o(e,n){d.invenioSearchErrorResults=n.data,d.invenioSearchError=e}function c(e,n){if(d.invenioSearchResults=n.data,d.invenioSearchErrorResults={},n.data.links){var r=t(n.data.links.self);r.page&&(r.page=parseInt(r.page)),r.size&&(r.size=parseInt(r.size)),delete r.q,angular.equals(d.invenioSearchCurrentArgs,r)||(d.invenioSearchSortArgs=r)}}function s(r,i){d.invenioSearchCurrentArgs=angular.merge({},d.invenioSearchCurrentArgs,i),d.invenioSearchArgs=angular.merge({},d.invenioSearchCurrentArgs.params),d.disableUrlHandler||(n.set(d.invenioSearchArgs),n.replace()),d.userQuery=d.invenioSearchArgs.q,d.invenioSearchInitialized=!0,d.invenioDoSearch(),e.$broadcast("invenio.search.initialiazed")}function l(e,r,i){void 0!==i&&!0===i?d.invenioSearchCurrentArgs.params=angular.copy(r):(d.invenioSearchCurrentArgs.params.page===r.page&&(r.page=1),angular.forEach(r,function(e,n){d.invenioSearchCurrentArgs.params[n]=e})),d.invenioSearchArgs=angular.copy(d.invenioSearchCurrentArgs.params),d.disableUrlHandler||n.set(d.invenioSearchCurrentArgs.params),d.userQuery=d.invenioSearchArgs.q,d.invenioDoSearch()}function h(r,i,a){if(!d.disableUrlHandler){var t=n.get();angular.equals(t,d.invenioSearchCurrentArgs.params)||e.$broadcast("invenio.search.request",t,!0)}}function u(n,r){var i=angular.copy(d.invenioSearchCurrentArgs.params);angular.forEach(r,function(e,n){i[n]=angular.copy(r[n])}),angular.equals(d.invenioSearchCurrentArgs.params,i)||e.$broadcast("invenio.search.request",i)}function v(n,r){angular.equals(n,d.invenioSearchCurrentArgs.params)||e.$broadcast("invenio.search.request",n)}var d=this;d.invenioSearchResults={},d.invenioSearchErrorResults={},d.invenioSearchLoading=!0,d.invenioSearchError={},d.invenioSearchInitialized=!1,d.invenioSearchArgs={},d.invenioSearchSortArgs={},d.invenioSearchCurrentArgs={method:"GET",params:{page:1,size:20}},d.invenioSearchGetUrlArgs=i,d.invenioDoSearch=a,d.parseURLQueryString=t,e.$on("invenio.search.initialazation",s),e.$on("invenio.search.request",l),e.$on("invenio.search.success",c),e.$on("invenio.search.error",o),e.$on("invenio.search.params.change",u),e.$on("$locationChangeStart",h),e.$watch("vm.invenioSearchArgs",v,!0)}function invenioSearchRangeFactory(){function e(e,r,t,l,d){o=angular.merge(l,o),n&&n.remove(),n=d3.select(e).append("svg").attr({width:o.width,height:o.height});var g=n.append("g").style("pointer-events","all"),S=d3.select("body").append("div").attr("class","range_tooltip").style({position:"absolute","text-align":"center",width:"40px",height:"18px",padding:"2px",font:"12px sans-serif",background:"lightblue",border:"0px","border-radius":"8px","pointer-events":"none",opacity:0});h(t);var p=d3.extent(t,function(e){return e.key});p[0]=p[0]-.1*t.length,p[1]=p[1]+.1*t.length,i=d3.scale.linear().domain(p).range([o.margins.left,o.width-o.margins.left-o.margins.right]);var f=Math.min(10,(o.width-o.margins.left-o.margins.right-t.length*o.padding)/(s-c));f=Math.max(1,f);var m=d3.max(t,function(e){return e.doc_count});a=d3.scale.linear().domain([0,m]).range([0,o.height-o.margins.bottom]);var y=g.selectAll(".bar").data(t).enter().append("g").attr("class","bar");y.append("rect").attr("height",function(e){return a(e.doc_count)}).attr("width",f).attr("x",function(e){return i(e.key)-f/2}).attr("y",function(e){return a.range()[1]-a(e.doc_count)}).style("fill",function(e){return e.selected?o.selectColor:o.barColor}),y.on("mouseenter",function(e){d3.select(this).select("rect").style("fill",d3.rgb(e.selected?o.selectColor:o.barColor).brighter()),S.transition().duration(200).style("opacity",.9),S.html(e.doc_count).style("left",d3.event.pageX+"px").style("top",d3.event.pageY-28+"px")}).on("mouseout",function(e){d3.select(this).select("rect").style("fill",e.selected?o.selectColor:o.barColor),S.transition().duration(500).style("opacity",0)}).on("click",function(e){u([e.key,e.key]),d3.select(".resize.e").style("display","inline")}),v(e,r,d)}var n,r,i,a,t,o,c,s,l=[],h=function(e){e.forEach(function(e){e.key=+e.key_as_string,o.selectionRange?e.selected=e.key>=o.selectionRange.min&&e.key<=o.selectionRange.max:e.selected=!0});var n=e.map(function(e){return e.key});c=Math.min.apply(void 0,n),s=Math.max.apply(void 0,n)},u=function(e){e=angular.copy(e),e[0]===e[1]&&(e[1]+=1e-5),t.extent(e),t(d3.select(".brush").transition()),t.event(d3.select(".brush").transition())},v=function(e,n,a){r&&r.remove(),r=d3.select(n).append("svg").attr({width:o.width,height:35}).style("fill",o.selectColor).style("overflow","visible"),r.append("line").attr({x1:0,x2:o.width,y1:5.5,y2:5.5}).style({stroke:o.lineColor,"stroke-width":3});var h=function(){var e=t.extent().map(Math.round);e.some(isNaN)&&(e=[c,s]),d3.select(".brush-range.min").text(e[0]),d3.select(".brush-range.max").text(e[1]),l=[],d3.selectAll("g.bar").select("rect").style("fill",function(n){return n.selected=n.key>=e[0]&&n.key<=e[1],n.selected&&l.push(n.key),n.selected?o.selectColor:o.barColor})},v=[c,s];if(o.selectionRange){var d=parseInt(i.domain()[0]),g=parseInt(i.domain()[1]);v=[o.selectionRange.min<d||o.selectionRange.min>g?d:o.selectionRange.min,o.selectionRange.max>g||o.selectionRange.max<d?g:o.selectionRange.max]}t=d3.svg.brush().x(i).extent(v).on("brush",h).on("brushend",function(){var e;0===l.length?e=[c,s]:(e=t.extent().map(Math.round),e[0]=Math.max(e[0],c),e[1]=Math.min(e[1],s)),u(e),a.apply(void 0,e)}),r.append("g").attr("class","brush").call(t).selectAll("rect").attr("y",4).attr("height",3);var S=r.selectAll(".resize").append("g");S.append("circle").attr("r",5).attr("cx",0).attr("cy",6).style({"stroke-width":2,stroke:o.selectColor,fill:o.circleColor}),S.append("text").attr("text-anchor","middle").style("transform","rotate(-45deg) translateX(-15px)").text(function(e,n){return parseInt(t.extent()[0===n?1:0])}).attr("class",function(e,n){return"brush-range "+(0===n?"max":"min")}).attr("y",31),parseInt(v[0])===parseInt(v[1])&&d3.select(".resize.e").style("display","inline")};return e}function invenioSearch(){function e(e,n,r,i){var a={url:r.searchEndpoint,method:r.searchMethod||"GET",headers:JSON.parse(r.searchHeaders||"{}")},t={params:JSON.parse(r.searchExtraParams||"{}")},o={params:i.invenioSearchGetUrlArgs()};i.disableUrlHandler=!!r.disableUrlHandler,i.invenioSearchHiddenParams=JSON.parse(r.searchHiddenParams||"{}");var c=angular.merge({},a,t,o);e.$broadcast("invenio.search.initialazation",c)}return{restrict:"AE",scope:!1,controller:"invenioSearchCtrl",controllerAs:"vm",link:e}}function invenioSearchBar(){function e(e,n,r,i){function a(){i.invenioSearchArgs.q=i.userQuery}e.placeholder=r.placeholder,e.updateQuery=a}function n(e,n){return n.template}return{restrict:"AE",require:"^invenioSearch",scope:!1,templateUrl:n,link:e}}function invenioSearchCount(){function e(e,n){return n.template}return{restrict:"AE",scope:!1,require:"^invenioSearch",templateUrl:e}}function invenioSearchError(){function e(e,n,r,i){e.errorMessage=r.message}function n(e,n){return n.template}return{restrict:"AE",scope:!1,require:"^invenioSearch",templateUrl:n,link:e}}function invenioSearchFacets(){function e(e,n,r,i){function a(n,r){e.handler[n]=void 0===e.handler[n]?[]:e.handler[n];var i=e.handler[n].indexOf(r);-1===i?e.handler[n].push(r):"string"==typeof e.handler[n]?e.handler[n]=[]:e.handler[n].splice(i,1);var a={};a[n]=angular.copy(e.handler[n]),e.$broadcast("invenio.search.params.change",a)}function t(n){return"string"==typeof e.handler[n]?[e.handler[n]]:e.handler[n]}e.handler=angular.copy(i.invenioSearchCurrentArgs.params),e.$on("invenio.search.finished",function(n){e.handler=angular.copy(i.invenioSearchCurrentArgs.params)}),e.handleClick=a,e.getValues=t}function n(e,n){return n.template}return{restrict:"AE",scope:!1,require:"^invenioSearch",templateUrl:n,link:e}}function invenioSearchLoading(){function e(e,n,r,i){e.loadingMessage=r.message}function n(e,n){return n.template}return{restrict:"AE",require:"^invenioSearch",templateUrl:n,link:e}}function invenioSearchPagination(){function e(e,n,r,i){function a(n,r){for(var i=(c(),n);i<=r;i++){var a=function(e){return{value:e,title:"Go to page "+e}}(i);e.paginatePages.push(a)}}function t(){e.paginatePages=[];var n,r,i=e.adjacentSize,t=o(),s=c(),l=2*i;t<=l+2?(n=1,a(n,t)):s-i<=2?(n=1,r=1+l,a(n,r)):s<t-(i+2)?(n=s-i,r=s+i,a(n,r)):(n=t-l,r=t,a(n,r))}function o(){var e;try{e=i.invenioSearchResults.hits.total}catch(n){e=0}return Math.ceil(e/i.invenioSearchArgs.size)}function c(){return parseInt(i.invenioSearchArgs.page)||1}function s(){var e=c();return e<o()&&(e+=1),e}function l(){var e=c();o();return e>1&&(e-=1),e}function h(e){return e===c()?"active":""}function u(){return c()<o()?"":"disabled"}function v(){return c()>1?"":"disabled"}function d(){return 1!==c()?"":"disabled"}function g(){return c()!==o()?"":"disabled"}function S(e){e>o()?i.invenioSearchArgs.page=o():i.invenioSearchArgs.page=e<1?1:e}e.paginatePages=[],e.adjacentSize=r.adjacentSize||4,e.showGoToFirstLast=r.showGoToFirstLast||!1,e.$watch("vm.invenioSearchArgs.page",function(e,n){e!==n&&t()}),e.$watch("vm.invenioSearchResults",function(e,n){t()}),e.paginationHelper={changePage:S,current:c,getFirstClass:d,getLastClass:g,getNextClass:u,getPageClass:h,getPrevClass:v,next:s,pages:t,previous:l,total:o}}function n(e,n){return n.template}return{restrict:"AE",scope:!1,require:"^invenioSearch",templateUrl:n,link:e}}function invenioSearchRange(e,n){function r(r,i,a,t){function o(e,n){if(!isNaN(e)&&!isNaN(n)){var i={},a={from:e,to:n},t=a.from+"--"+a.to;i[s.name]=t,r.$broadcast("invenio.search.params.change",i)}}function c(){if(h&&(s.width=l()||u),t.invenioSearchResults.aggregations){var n=t.invenioSearchResults.aggregations[s.name].buckets;if(n.length>0){if(t.invenioSearchArgs[s.name]){var r=t.invenioSearchArgs[s.name].split("--"),i=+r[0],a=2===r.length?+r[1]:i;isNaN(i)||isNaN(a)||(s.selectionRange={min:i,max:a})}e(s.histogramId,s.selectionId,n,s,o)}}}var s={height:70,name:"years",histogramId:"#hist",selectionId:"#select",margins:{left:10,right:10,top:10,bottom:0},barColor:"#2c3e50",selectColor:"#3498db",lineColor:"#ccc",circleColor:"white",padding:2},l=function(){return d3.select(s.histogramId).node().getBoundingClientRect().width};angular.merge(s,angular.fromJson(a.options));var h=!s.width;if(h)var u=l();r.$on("invenio.search.finished",c),h&&angular.element(n).bind("resize",c)}function i(e,n){return n.template}return{restrict:"AE",require:"^invenioSearch",templateUrl:i,link:r}}function invenioSearchResults(){function e(e,n,r,i){e.recordTemplate=r.recordTemplate}function n(e,n){return n.template}return{restrict:"AE",scope:!1,require:"^invenioSearch",templateUrl:n,link:e}}function invenioSearchSelectBox(){function e(e,n,r,i){function a(n){var r=i.invenioSearchArgs[e.data.sortKey]||i.invenioSearchSortArgs[e.data.sortKey]||e.data.defaultSortBy||"";return"-"===r.charAt(0)&&(r=r.slice(1,r.length)),"-"===n.charAt(0)&&(n=n.slice(1,n.length)),r===n}function t(){i.invenioSearchArgs[e.data.sortKey]=e.data.selectedOption}function o(n,r){if(n){var i=null;i="-"===n.charAt(0)?n.slice(1,n.length):n,i.length&&(e.data.selectedOption=i)}}e.data={availableOptions:JSON.parse(r.availableOptions||"{}"),selectedOption:i.invenioSearchArgs[r.sortKey]||null,sortKey:r.sortKey||"sort",defaultSortBy:r.defaultSortBy},null===e.data.selectedOption&&(e.data.selectedOption=e.data.availableOptions.options[0].value),e.isSelected=a,e.handleFieldChange=t,e.$watchCollection("vm.invenioSearchSortArgs."+e.data.sortKey,o),e.$watchCollection("vm.invenioSearchArgs."+e.data.sortKey,o)}function n(e,n){return n.template}return{restrict:"AE",require:"^invenioSearch",templateUrl:n,link:e}}function invenioSearchSortOrder(){function e(e,n,r,i){function a(n,r){var a={};a[n]=r||null,i.invenioSearchArgs=angular.merge(i.invenioSearchArgs,a),e.whichOrder="-"!==(r||"").charAt(0)?"asc":"desc"}function t(){var n=i.invenioSearchArgs[e.sortKey]||i.invenioSearchCurrentArgs[e.sortKey]||this.data.selectedOption||"";"-"===n.charAt(0)&&(n=n.slice(1,n.length)),"asc"===e.whichOrder?a(e.sortKey,n):"desc"===e.whichOrder&&a(e.sortKey,"-"+n)}function o(n,r){n&&(e.whichOrder="-"!==n.charAt(0)?"asc":"desc")}e.sortKey=r.sortKey,e.handleOrderChange=t,e.whichOrder="asc",e.$watchCollection("vm.invenioSearchSortArgs."+e.sortKey,o),e.$watchCollection("vm.invenioSearchArgs."+e.sortKey,o)}function n(e,n){return n.template}return{restrict:"AE",require:"^invenioSearch",templateUrl:n,link:e}}function invenioSearchAPI(e,n){function r(r,i){function a(e){o.resolve(e)}function t(e){o.reject(e)}var o=n.defer(),c=angular.copy(r);return c.params=angular.merge(c.params,i||{}),e(c).then(a,t),o.promise}return{search:r}}function invenioSearchHandler(e){function n(){return e.search()}function r(n){e.search(n)}function i(){e.replace()}return{get:n,replace:i,set:r}}invenioSearchConfiguration.$inject=["$locationProvider"],angular.module("invenioSearch.configuration",[]).config(invenioSearchConfiguration),angular.module("invenioSearch.services",[]),angular.module("invenioSearch.factories",[]),angular.module("invenioSearch.controllers",[]),angular.module("invenioSearch.directives",[]),angular.module("invenioSearch",["invenioSearch.configuration","invenioSearch.services","invenioSearch.factories","invenioSearch.controllers","invenioSearch.directives"]),invenioSearchCtrl.$inject=["$scope","invenioSearchHandler","invenioSearchAPI"],angular.module("invenioSearch.controllers").controller("invenioSearchCtrl",invenioSearchCtrl),angular.module("invenioSearch.factories").factory("invenioSearchRangeFactory",invenioSearchRangeFactory),angular.module("invenioSearch.directives").directive("invenioSearch",invenioSearch),angular.module("invenioSearch.directives").directive("invenioSearchBar",invenioSearchBar),angular.module("invenioSearch.directives").directive("invenioSearchCount",invenioSearchCount),angular.module("invenioSearch.directives").directive("invenioSearchError",invenioSearchError),angular.module("invenioSearch.directives").directive("invenioSearchFacets",invenioSearchFacets),angular.module("invenioSearch.directives").directive("invenioSearchLoading",invenioSearchLoading),angular.module("invenioSearch.directives").directive("invenioSearchPagination",invenioSearchPagination),invenioSearchRange.$inject=["invenioSearchRangeFactory","$window"],angular.module("invenioSearch.directives").directive("invenioSearchRange",invenioSearchRange),angular.module("invenioSearch.directives").directive("invenioSearchResults",invenioSearchResults),angular.module("invenioSearch.directives").directive("invenioSearchSelectBox",invenioSearchSelectBox),angular.module("invenioSearch.directives").directive("invenioSearchSortOrder",invenioSearchSortOrder),invenioSearchAPI.$inject=["$http","$q"],angular.module("invenioSearch.services").service("invenioSearchAPI",invenioSearchAPI),invenioSearchHandler.$inject=["$location"],angular.module("invenioSearch.services").service("invenioSearchHandler",invenioSearchHandler);